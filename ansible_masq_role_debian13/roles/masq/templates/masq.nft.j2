
# Managed by Ansible (role: masq)
# NAT table with IPv4 masquerade on the egress interface

table ip nat {
  chains {
    prerouting { type nat hook prerouting priority -100; }
    postrouting { type nat hook postrouting priority 100; }
  }
  chain postrouting {
    # Masquerade traffic from internal network out via WAN
{% if internal_ipv4_cidr | length > 0 %}
    ip saddr {{ internal_ipv4_cidr }} oifname "{{ wan_iface }}" masquerade
{% else %}
    oifname "{{ wan_iface }}" masquerade
{% endif %}
  }
}

# Optional IPv6 (rarely used; only if enable_ipv6=true and internal_ipv6_cidr set)
{% if enable_ipv6 and internal_ipv6_cidr | length > 0 %}
table ip6 nat {
  chains {
    prerouting { type nat hook prerouting priority -100; }
    postrouting { type nat hook postrouting priority 100; }
  }
  chain postrouting {
    ip6 saddr {{ internal_ipv6_cidr }} oifname "{{ wan_iface }}" masquerade
  }
}
{% endif %}
